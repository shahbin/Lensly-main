<%- include("../../views/partials/user/header" , { user: user }) %>
    <!--=============== MAIN ===============-->
    <main class="main">
      <!--=============== BREADCRUMB ===============-->
      <section class="breadcrumb" style="width: 100%; height: 80px; display: flex; margin-top: -40px; justify-content: center; align-items: center; background-color: #ffff;" >
        <ul class="breadcrumb__list  container" style=" margin-left: -25px;">
          <li><a href="/" class="breadcrumb__link" style="font-size: 12px ;">Home</a></li>
          <li><span class="breadcrumb__link">></span></li>
          <li><a href="/shop" class="breadcrumb__link" style="font-size: 12px ;">Shop</a></li>
          <li><span class="breadcrumb__link">></span></li>
          <li><a href="/cart" class="breadcrumb__link" style="font-size: 12px ;">Cart</a></li>
          <li><span class="breadcrumb__link">></span></li>
          <li><a href="/checkout" class="breadcrumb__link" style="font-size: 12px ;">Checkout</a></li>
          <li><span class="breadcrumb__link">></span></li>
          <li><a  class="breadcrumb__link" style="font-size: 12px ;">Order details</a></li>
        </ul>
      </section>

      <section class="order-details section--lg">
        <div class="order-details__container container">
          <h1 class="order-summary__title" style="margin-bottom: 100px; margin-top: -70px; color: rgb(17, 3, 34);">Order Details</h1>
          <% if (order) { %>
            <div class="order-user">
              <h3 class="order-user__name"><%= user.name %></h3>
            </div>
            <div style="display: flex; justify-content: space-between;">
            <div class="order-address">
              <h2>Shipping Address</h2>
              <% if (order.shippingAddress) { %>
                <div class="address-details">
                  <p class="address-name"><%= order.shippingAddress.name %></p>
                  <% if (order.shippingAddress.landMark) { %>
                    <p class="address-landmark"><%= order.shippingAddress.landMark %></p>
                  <% } %>
                  <p class="address-location">
                    <%= order.shippingAddress.city %>, 
                    <%= order.shippingAddress.state %> - 
                    <%= order.shippingAddress.pincode %>
                  </p>
                  <p class="address-phone">Phone: <%= order.shippingAddress.phone %></p>
                  <% if (order.shippingAddress.altPhone) { %>
                    <p class="address-alt-phone">Alt Phone: <%= order.shippingAddress.altPhone %></p>
                  <% } %>
                </div>
              <% } else { %>
                <p class="no-address">Address not available</p>
              <% } %>
            </div>
            <div class="order-tracker">
              <h2 class="order-tracker__title">Payment Method</h2>
              <p><%= order.paymentMethod %></p>  
              <p>Status : <%= order.paymentStatus %></p>   
            </div>
            <br>
            <div class="order-tracker">
              <h2 class="order-tracker__title">Order Tracker</h2>
              <p>Status: <%= order.status %></p>
            </div>
          </div>
            <div class="order-summary">
              <h3 class="order-summary__title">Order Summary</h3>
              <table class="order-summary__table">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Details</th>
                    <!-- <th>Total</th> -->
                  </tr>
                </thead>
                <tbody>
                  <% order.orderedItems.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded)); %>
                  <% order.orderedItems.forEach(item => { %>
                    <tr>
                      <td><img src="/admin-assets/imgs/brands/<%= item.product.productImage[0] %>" alt="Product Image" class="order__img" /></td>
                      <td>
                        <h3 class="table__title"><%= item.product.productName %></h3>
                        <p class="table__quantity">x <%= item.quantity %></p>
                        <p class="status  <%= item.status?.toLowerCase() %>" style="color: #d33; font-size: larger; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;"><%= item.status || 'Pending' %></p>
                        <% if (!item.status || item.status.toLowerCase() !== 'cancelled') { %>
                        <button class="cancel-btn" onclick="cancelOrderItem('<%= order._id %>', '<%= item._id %>')">Cancel</button>
                        <% } %>
                      </td>
                      <!-- <td><span class="table__price">₹<%= item.price.toFixed(2) %></span></td> -->
                    </tr>
                  <% }) %>
                  <tr>
                    <td><span class="order__subtitle">Subtotal</span></td>
                    <td colspan="2"><span class="table__price">₹<%= order.totalPrice.toFixed(2) %></span></td>
                  </tr>
                  <tr>
                    <td><span class="order__subtitle">Shipping</span></td>
                    <td colspan="2"><span class="table__price">₹49.00</span></td>
                  </tr>
                  <tr>
                    <td><span class="order__subtitle">Discount</span></td>
                    <td colspan="2"><span class="table__price">₹<%= order.discount.toFixed(2) %></span></td>
                  </tr>
                  <tr>
                    <td><span class="order__subtitle">Total</span></td>
                    <td colspan="2"><span class="order__grand-total">₹<%= order.finalAmount.toFixed(2) %></span></td>
                  </tr>
                </tbody>
              </table>
            </div>
          <% } else { %>
            <p class="error-message"><%= error %></p>
          <% } %>
          <div class="order-actions">
            <a href="/shop" class="btn btn--md">Continue Shopping</a>
          </div>
        </div>
      </section>
    </main>


<!-- Add this in your EJS template -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function cancelOrderItem(orderId, itemId) {
    // Initial confirmation dialog
    Swal.fire({
      title: 'Cancel Order Item',
      text: 'Are you sure you want to cancel this item?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, cancel it!',
      cancelButtonText: 'No, keep it'
    }).then((result) => {
      if (result.isConfirmed) {
        // Show loading state
        Swal.fire({
          title: 'Processing...',
          text: 'Cancelling your order item',
          allowOutsideClick: false,
          allowEscapeKey: false,
          allowEnterKey: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        // Make the cancellation request
        fetch(`/cancel-order-item/${orderId}/${itemId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Success dialog
            Swal.fire({
              title: 'Cancelled Successfully!',
              text: 'Your order item has been cancelled.',
              icon: 'success',
              confirmButtonColor: '#3085d6',
              confirmButtonText: 'OK'
            }).then((result) => {
              if (result.isConfirmed) {
                location.reload();
              }
            });
          } else {
            throw new Error(data.message || 'Cancellation failed');
          }
        })
        .catch(error => {
          // Error dialog
          Swal.fire({
            title: 'Cancellation Failed',
            text: 'There was an error cancelling your order item. Please try again.',
            icon: 'error',
            confirmButtonColor: '#3085d6',
            confirmButtonText: 'OK'
          });
        });
      }
    });
  }
</script>

<!-- Add this CSS for better button styling -->
<style>
  .cancel-btn {
    background-color: #d33;
    color: white;
    border: 1px solid #d33;
    padding: 8px 15px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .cancel-btn:hover {
    background-color: white;
    color: #d33;
  }

  .swal2-popup {
    font-size: 0.9rem !important;
  }
</style>

    <%- include("../../views/partials/user/footer") %>